#!/usr/bin/env python3
"""
Áã¨Á´ãÁöÑQQÈü≥‰πê‰∏ãËΩΩÊúçÂä°
‰∏ç‰æùËµñÂéüÈ°πÁõÆÁöÑÂÖ∂‰ªñÁà¨Ëô´‰ª£Á†Å,‰ªÖÊèê‰æõQQÈü≥‰πêÂäüËÉΩ
"""

import os
import yaml
import asyncio
import tempfile
import yt_dlp

from fastapi import FastAPI, Request, HTTPException, Body
from fastapi.responses import HTMLResponse
from pydantic import BaseModel, Field
from typing import Optional, List
import uvicorn

# ËØªÂèñÈÖçÁΩÆ
config_path = os.path.join(os.path.dirname(__file__), 'config.yaml')
with open(config_path, 'r', encoding='utf-8') as file:
    config = yaml.safe_load(file)


# ============ Êï∞ÊçÆÊ®°Âûã ============

class QQMusicDownloadRequest(BaseModel):
    """QQÈü≥‰πê‰∏ãËΩΩËØ∑Ê±Ç"""
    cookie: str = Field(..., description="QQÈü≥‰πêCookie (NetscapeÊ†ºÂºè)")
    url: str = Field(..., description="Ê≠åÊõ≤ÊàñÊ≠åÂçïÈìæÊé•")
    format: Optional[str] = Field(default="128mp3", description="Èü≥È¢ëÊ†ºÂºè")


class SongInfo(BaseModel):
    """Ê≠åÊõ≤‰ø°ÊÅØ"""
    title: str
    artist: Optional[str] = None
    album: Optional[str] = None
    download_url: Optional[str] = None
    duration: Optional[int] = None
    filesize: Optional[int] = None
    format: Optional[str] = None
    error: Optional[str] = None


# ============ FastAPIÂ∫îÁî® ============

app = FastAPI(
    title="QQ Music Downloader",
    description="QQÈü≥‰πê‰∏ãËΩΩÊúçÂä°",
    version="1.0.0"
)


# ============ APIÁ´ØÁÇπ ============

@app.post("/api/qqmusic/download")
async def qqmusic_download(request: Request, req: QQMusicDownloadRequest = Body(...)):
    """Ëé∑ÂèñQQÈü≥‰πê‰∏ãËΩΩÈìæÊé•"""

    cookie_file = None
    try:
        # ÂàõÂª∫‰∏¥Êó∂cookieÊñá‰ª∂
        with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.txt') as f:
            cookie_file = f.name
            f.write(req.cookie)

        # ÈÖçÁΩÆyt-dlp
        ydl_opts = {
            'cookiefile': cookie_file,
            'quiet': True,
            'no_warnings': True,
            'extract_flat': False,
            'format': req.format if req.format != 'bestaudio' else 'bestaudio',
            'ignoreerrors': True,
        }

        songs = []

        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(req.url, download=False)

            if 'entries' in info:
                # Ê≠åÂçï
                for entry in info['entries']:
                    if entry is None:
                        continue

                    song = SongInfo(
                        title=entry.get('title', 'Unknown'),
                        artist=entry.get('artist') or entry.get('uploader'),
                        album=entry.get('album'),
                        download_url=entry.get('url'),
                        duration=entry.get('duration'),
                        filesize=entry.get('filesize') or entry.get('filesize_approx'),
                        format=entry.get('ext'),
                        error=None if entry.get('url') else "Êó†Ê≥ïËé∑Âèñ‰∏ãËΩΩÈìæÊé•"
                    )
                    songs.append(song.dict())
            else:
                # ÂçïÊõ≤
                song = SongInfo(
                    title=info.get('title', 'Unknown'),
                    artist=info.get('artist') or info.get('uploader'),
                    album=info.get('album'),
                    download_url=info.get('url'),
                    duration=info.get('duration'),
                    filesize=info.get('filesize') or info.get('filesize_approx'),
                    format=info.get('ext'),
                    error=None if info.get('url') else "Êó†Ê≥ïËé∑Âèñ‰∏ãËΩΩÈìæÊé•"
                )
                songs.append(song.dict())

        return {
            "code": 200,
            "router": request.url.path,
            "data": {
                "total": len(songs),
                "songs": songs
            }
        }

    except Exception as e:
        raise HTTPException(
            status_code=400,
            detail={
                "code": 400,
                "router": request.url.path,
                "params": {"url": req.url, "format": req.format, "error": str(e)}
            }
        )

    finally:
        # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
        if cookie_file and os.path.exists(cookie_file):
            try:
                os.unlink(cookie_file)
            except:
                pass


# ============ WebÁïåÈù¢ ============

@app.get("/", response_class=HTMLResponse)
async def index():
    """‰∏ªÈ°µ"""
    html_content = """
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>üéµ QQÈü≥‰πê‰∏ãËΩΩÂô®</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }

            body {
                font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 900px;
                margin: 0 auto;
                background: white;
                border-radius: 20px;
                padding: 40px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            }

            h1 {
                text-align: center;
                color: #667eea;
                margin-bottom: 10px;
                font-size: 2.5em;
            }

            .subtitle {
                text-align: center;
                color: #7f8c8d;
                margin-bottom: 30px;
            }

            .info-box {
                background: #e7f3ff;
                border-left: 4px solid #1c7ed6;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 25px;
                color: #163a5f;
            }

            .form-group {
                margin-bottom: 20px;
            }

            label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #2c3e50;
            }

            textarea, input, select {
                width: 100%;
                padding: 12px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 14px;
                transition: border-color 0.3s;
            }

            textarea:focus, input:focus, select:focus {
                outline: none;
                border-color: #667eea;
            }

            textarea {
                min-height: 150px;
                font-family: monospace;
                resize: vertical;
            }

            button {
                width: 100%;
                padding: 15px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 25px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }

            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            }

            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            #result {
                margin-top: 30px;
            }

            .song-item {
                background: #f8f9fa;
                padding: 20px;
                margin-bottom: 15px;
                border-radius: 10px;
                border-left: 4px solid #667eea;
                transition: transform 0.2s;
            }

            .song-item:hover {
                transform: translateX(5px);
            }

            .song-title {
                font-size: 1.2em;
                font-weight: bold;
                color: #2c3e50;
                margin-bottom: 8px;
            }

            .song-meta {
                color: #7f8c8d;
                font-size: 0.9em;
                margin-bottom: 10px;
            }

            .download-btn {
                display: inline-block;
                padding: 8px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                text-decoration: none;
                border-radius: 20px;
                font-weight: 600;
                transition: all 0.3s;
            }

            .download-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            }

            .error {
                color: #e03131;
                margin-top: 10px;
            }

            .success-box {
                background: #e6f4ea;
                border-left: 4px solid #2f9e44;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                color: #1e4620;
            }

            .loading {
                text-align: center;
                padding: 20px;
                color: #667eea;
                font-size: 1.1em;
            }

            .warning-box {
                background: #fff3cd;
                border-left: 4px solid #ffc107;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                color: #856404;
            }

            .progress-info {
                background: #e7f3ff;
                border-left: 4px solid #1c7ed6;
                padding: 15px;
                border-radius: 8px;
                margin: 15px 0;
                color: #163a5f;
            }

            .spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(102, 126, 234, 0.3);
                border-radius: 50%;
                border-top-color: #667eea;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üéµ QQÈü≥‰πê‰∏ãËΩΩÂô®</h1>
            <p class="subtitle">ÊîØÊåÅÂçïÊõ≤ÂíåÊ≠åÂçïÊâπÈáè‰∏ãËΩΩ</p>

            <div class="info-box">
                <strong>üìå ‰ΩøÁî®ËØ¥Êòé:</strong><br/>
                1. ‰ΩøÁî®CookieÂØºÂá∫Â∑•ÂÖ∑‰ªéQQÈü≥‰πêÁΩëÁ´ôÂØºÂá∫Cookie (NetscapeÊ†ºÂºè)<br/>
                2. Á≤òË¥¥Ê≠åÊõ≤ÊàñÊ≠åÂçïÈìæÊé•<br/>
                3. ÈÄâÊã©Èü≥È¢ëÊ†ºÂºè,ÁÇπÂáªËé∑Âèñ‰∏ãËΩΩÈìæÊé•
            </div>

            <form id="downloadForm">
                <div class="form-group">
                    <label for="cookie">üç™ QQÈü≥‰πêCookie (NetscapeÊ†ºÂºè) *</label>
                    <textarea id="cookie" required placeholder="# Netscape HTTP Cookie File
.qq.com	TRUE	/	FALSE	0	uin	12345
.qq.com	TRUE	/	FALSE	0	qm_keyst	xxxxx"></textarea>
                </div>

                <div class="form-group">
                    <label for="url">üîó Ê≠åÊõ≤ÊàñÊ≠åÂçïÈìæÊé• *</label>
                    <input type="url" id="url" required placeholder="https://y.qq.com/n/ryqq/playlist/...">
                    <div id="urlTypeHint" style="margin-top: 8px; font-size: 0.9em; font-weight: 600;"></div>
                </div>

                <div class="form-group">
                    <label for="format">üéß Èü≥È¢ëÊ†ºÂºè</label>
                    <select id="format">
                        <option value="128mp3">128kbps MP3 (Êé®Ëçê)</option>
                        <option value="320mp3">320kbps MP3</option>
                        <option value="flac">FLACÊó†Êçü</option>
                        <option value="m4a">M4A</option>
                        <option value="bestaudio">ÊúÄ‰Ω≥Èü≥Ë¥®</option>
                    </select>
                </div>

                <button type="submit" id="submitBtn">üöÄ Ëé∑Âèñ‰∏ãËΩΩÈìæÊé•</button>
            </form>

            <div id="result"></div>
        </div>

        <script>
            const form = document.getElementById('downloadForm');
            const submitBtn = document.getElementById('submitBtn');
            const resultDiv = document.getElementById('result');

            // ‰∏ãËΩΩÊ≠åÊõ≤ÂáΩÊï∞
            function downloadSong(url, filename, statusId) {
                const statusDiv = document.getElementById(statusId + '_status');
                statusDiv.innerHTML = '<span style="color: #667eea;">‚è≥ Â∑≤Ëß¶Âèë‰∏ãËΩΩ...</span>';

                try {
                    // Ëé∑ÂèñÊñá‰ª∂Êâ©Â±ïÂêç
                    const ext = url.includes('.m4a') ? '.m4a' :
                                url.includes('.flac') ? '.flac' :
                                url.includes('.mp3') ? '.mp3' : '.m4a';

                    const safeFilename = filename.replace(/[<>:"/\\|?*]/g, '_') + ext;

                    // Áõ¥Êé•ÂàõÂª∫‰∏ãËΩΩÈìæÊé•(ÊµèËßàÂô®ÂéüÁîü‰∏ãËΩΩ)
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = safeFilename;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    statusDiv.innerHTML = '<span style="color: #2f9e44;">‚úÖ ‰∏ãËΩΩÂ∑≤ÂºÄÂßã(Áî±ÊµèËßàÂô®Â§ÑÁêÜ)</span>';

                    // 5ÁßíÂêéÊ∏ÖÈô§Áä∂ÊÄÅ
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 5000);
                } catch (error) {
                    statusDiv.innerHTML = '<span style="color: #e03131;">‚ùå Ëß¶ÂèëÂ§±Ë¥•: ' + error.message + '</span>';
                }
            }

            // Ê£ÄÊµãURLÁ±ªÂûãÂπ∂ÊòæÁ§∫ÊèêÁ§∫
            const urlInput = document.getElementById('url');
            urlInput.addEventListener('input', (e) => {
                const url = e.target.value;
                const hintDiv = document.getElementById('urlTypeHint');

                if (url.includes('/playlist/')) {
                    hintDiv.innerHTML = 'üí° Ê£ÄÊµãÂà∞Ê≠åÂçïÈìæÊé• - Ëß£ÊûêÊ≠åÂçïÈúÄË¶ÅËæÉÈïøÊó∂Èó¥,ËØ∑ËÄêÂøÉÁ≠âÂæÖ';
                    hintDiv.style.color = '#ffc107';
                } else if (url.includes('/songDetail/')) {
                    hintDiv.innerHTML = '‚úÖ Ê£ÄÊµãÂà∞ÂçïÊõ≤ÈìæÊé• - Ëß£ÊûêÈÄüÂ∫¶ËæÉÂø´';
                    hintDiv.style.color = '#2f9e44';
                } else {
                    hintDiv.innerHTML = '';
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const cookie = document.getElementById('cookie').value;
                const url = document.getElementById('url').value;
                const format = document.getElementById('format').value;

                // Âà§Êñ≠ÊòØÊ≠åÂçïËøòÊòØÂçïÊõ≤
                const isPlaylist = url.includes('/playlist/');

                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Â§ÑÁêÜ‰∏≠...';

                if (isPlaylist) {
                    resultDiv.innerHTML = `
                        <div class="warning-box">
                            <strong>‚è∞ Ê≠£Âú®Ëß£ÊûêÊ≠åÂçï</strong><br/>
                            Ê≠åÂçïËß£ÊûêÈúÄË¶ÅËæÉÈïøÊó∂Èó¥,ËØ∑ËÄêÂøÉÁ≠âÂæÖ...<br/>
                            <div style="margin-top: 10px;">
                                <span class="spinner"></span>
                                <span style="margin-left: 10px;">Ê≠£Âú®ÈÄêÈ¶ñÊèêÂèñÊ≠åÊõ≤‰ø°ÊÅØ</span>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="loading">Ê≠£Âú®Ëé∑ÂèñÊ≠åÊõ≤‰ø°ÊÅØ,ËØ∑Á®çÂÄô...</div>';
                }

                try {
                    const response = await fetch('/api/qqmusic/download', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ cookie, url, format })
                    });

                    const data = await response.json();

                    if (data.code === 200) {
                        const songs = data.data.songs;
                        const total = data.data.total;

                        let html = `<div class="success-box"><strong>‚úÖ Ëß£ÊûêÊàêÂäü!</strong><br/>ÂÖ±ÊâæÂà∞ ${total} È¶ñÊ≠åÊõ≤</div>`;

                        songs.forEach((song, index) => {
                            const songId = `song_${index}`;
                            html += `
                                <div class="song-item">
                                    <div class="song-title">${index + 1}. ${song.title}</div>
                                    <div class="song-meta">
                                        üé§ ${song.artist || 'Unknown'}
                                        ${song.album ? `| üíø ${song.album}` : ''}
                                        ${song.duration ? `| ‚è±Ô∏è ${Math.floor(song.duration / 60)}:${(song.duration % 60).toString().padStart(2, '0')}` : ''}
                                    </div>
                                    ${song.download_url ?
                                        `<button class="download-btn" onclick="downloadSong('${song.download_url}', '${song.title.replace(/'/g, "\\'")} - ${(song.artist || 'Unknown').replace(/'/g, "\\'")}', '${songId}')">‚¨áÔ∏è ‰∏ãËΩΩ</button>` :
                                        `<div class="error">‚ö†Ô∏è ${song.error || 'Êó†Ê≥ïËé∑Âèñ‰∏ãËΩΩÈìæÊé•'}</div>`
                                    }
                                    <div id="${songId}_status" style="margin-top: 8px; font-size: 0.9em;"></div>
                                </div>
                            `;
                        });

                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `<div class="info-box" style="background: #fdecea; border-left-color: #e03131; color: #5c2b29;">‚ùå Ëß£ÊûêÂ§±Ë¥•: ${data.detail?.params?.error || 'Êú™Áü•ÈîôËØØ'}</div>`;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `<div class="info-box" style="background: #fdecea; border-left-color: #e03131; color: #5c2b29;">‚ùå ÂèëÁîüÈîôËØØ: ${error.message}</div>`;
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üöÄ Ëé∑Âèñ‰∏ãËΩΩÈìæÊé•';
                }
            });
        </script>
    </body>
    </html>
    """
    return HTMLResponse(content=html_content)


# ============ ÂêØÂä®ÊúçÂä° ============

if __name__ == "__main__":
    print("="*60)
    print("üéµ QQÈü≥‰πê‰∏ãËΩΩÊúçÂä°")
    print("="*60)
    print("üìç WebÁïåÈù¢: http://localhost:8080")
    print("üìç APIÊñáÊ°£: http://localhost:8080/docs")
    print("="*60)

    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8080,
        log_level="info"
    )
